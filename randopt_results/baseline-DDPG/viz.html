<!DOCTYPE html>
<html lang="en">
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script>

        <title>Randopt Visualization</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css">

        <!-- Tabler Bootstrap -->
        <link rel="stylesheet" href="https://tabler.github.io/tabler/assets/css/dashboard.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

        <!-- AngularJS 1.x -->
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.1/angular.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.1/angular-route.min.js"></script>

        <!-- ag-Grid -->
        <script src="https://unpkg.com/ag-grid@18.1.1/dist/ag-grid.min.js"></script>


        <!-- Custom Styles -->
        <style>
            .code {
                background-color: #fdf6e3;
                padding: 1em;
                margin: .5em 0;
                overflow: auto;
                border-radius: 0.3em;
                color: #657b83;
                font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
                text-align: left;
                white-space: pre;
                word-spacing: normal;
                word-break: normal;
                word-wrap: normal;
                line-height: 1.5;
                -moz-tab-size: 4;
                -o-tab-size: 4;
                tab-size: 4;
                -webkit-hyphens: none;
                -moz-hyphens: none;
                -ms-hyphens: none;
                hyphens: none;
            }

            .away {
                position:absolute;
                left:-9999px;           
                top: -1000px;
            }

            .print-page-break { display: none; }


            .plot-selected {
                border-color:orange;
            }

            /* Chrome, Safari and Opera syntax */
            :-webkit-full-screen .header {
                display:none !important;
            }

            /* Firefox syntax */
            :-moz-full-screen .header {
                display:none !important;
            }

            /* IE/Edge syntax */
            :-ms-fullscreen .header {
                display:none !important;
            }

            /* Standard syntax */
            :fullscreen .header {
                display:none !important;
            }


            @media print {

                @page { size: auto;  margin: 0mm; }

                body {
                    text-align: center;
                    margin: 0;
                    padding: 0 !important;
                    width: 1024px;
                }

                .container, .print-plot-width {
                    text-align: center !important;
                    width: 926px !important;
                }

                .print-page-break {
                    display: block;
                    width: 500px;
                    height: 125px;
                    page-break-after: always;
                }

                body {
                    font-size: 12px;
                }

                .noprint,
                div.alert,
                header,
                .group-media,
                .btn,
                .footer,
                form,
                #comments,
                .nav,
                ul.links.list-inline,
                ul.action-links {
                    display:none !important;
                }
            }

        </style>
    </head>
    <body ng-app="rovizApp">

        <div ng-controller="RovizController as roviz">


            <!-- First line of Header-->
            <div class="header py-4">
                <div class="container">
                    <div class="d-flex">
                        <a class="header-brand" href="./index.html">
                            <img src="https://seba-1511.github.io/randopt/assets/images/logo.png" class="header-brand-img" alt="randopt logo">
                        </a>

                        <!-- Randopt Link -->
                        <div class="d-flex order-lg-2 ml-auto">
                            <div class="nav-item d-none d-md-flex">
                                <a href="https://github.com/seba-1511/randopt" class="btn btn-sm btn-outline-info" target="_blank">
                                    <i class="fa fa-github"></i>
                                    GitHub
                                </a>
                            </div>
                            <div class="nav-item d-none d-md-flex">
                                <a href="https://randopt.ml" class="btn btn-sm btn-outline-info" target="_blank">
                                    <i class="fe fe-download-cloud"></i>
                                    Get Randopt!
                                </a>
                            </div>
                        </div>

                        <!-- Menu button for mobile -->
                        <a href="#" class="header-toggler d-lg-none ml-3 ml-lg-0" data-toggle="collapse" data-target="#headerMenuCollapse">
                            <span class="header-toggler-icon"></span>
                        </a>

                    </div>
                </div>
            </div>

            <!-- Second line of Header -->
            <div class="header collapse d-lg-flex p-0" id="headerMenuCollapse">
                <div class="container">
                    <div class="row align-items-center">

                        <div class="col-lg order-lg-first">
                            <ul class="nav nav-tabs border-0 flex-column flex-lg-row">
                                <li class="nav-item">
                                    <a ng-click="page = 'home'" class="nav-link" ng-class="{'active': page == 'home'}">
                                        <i class="fe fe-home"></i> 
                                        Home
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a ng-click="page = 'data'" class="nav-link" ng-class="{'active': page == 'data'}">
                                        <i class="fe fe-box"></i> 
                                        Data &nbsp;
                                        <small class="">({{roviz.data.length}})</small>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a ng-click="page = 'plots'" class="nav-link" ng-class="{'active': page == 'plots'}">
                                        <i class="fa fa-line-chart"></i>
                                        Plots &nbsp;
                                        <small class="">({{roviz.plots.length}})</small>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="https://github.com/seba-1511/randopt/wiki" target="_blank" class="nav-link"><i class="fe fe-file-text"></i> Documentation</a>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-3 text-right">
                            <a class="btn btn-info" style="color:white;" ng-click="roviz.export();">
                                <i class="fe fe-share-2"></i>
                                Share this page
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Home Page -->
            <div ng-show="page == 'home'" class="container">
                <br />
                <h3>Home</h3>

                <div class="offset-md-2 col-md-8 card">
                    <h3 style="margin-top:10px;">Keyboard Shortcuts</h3> 

                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th scope="col">Command</th>
                                <th scope="col">Mapping</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th>Shift + ?</th>
                                <td>Go to Home Tab</td>
                            </tr>
                            <tr>
                                <th>Shift + D</th>
                                <td>Go to Data Tab</td>
                            </tr>
                            <tr>
                                <th>Shift + P</th>
                                <td>Go to Plots Tab</td>
                            </tr>
                            <tr>
                                <th>Shift + H / L</th>
                                <td>Go to Previous / Next Tab</td>
                            </tr>
                            <tr>
                                <th>J / K</th>
                                <td>Scroll Down/Up</td>
                            </tr>
                            <tr>
                                <th>F</th>
                                <td>Fullscreen</td>
                            </tr>
                        </tbody>
                    </table>

                </div>
            </div>


            <!-- Data Page -->
            <div ng-show="page == 'data'" class="container" style="height:100%;">

                <br />
                <h3>Data <small>{{roviz.data.length}} summaries</small></h3>

                <div class="col-md-12 card">
                    <div class="row" style="margin:10px;">
                        <div class="col-md-3">
                            <form ng-submit="roviz.updateQuickFilter();">
                                <input type="text" placeholder="Search..." id="dataFilter" class="form-control" />
                                <input type="submit" style="position:absolute;left:-9999px;width:1px;height:1px;" />
                            </form>
                        </div>
                        <!-- <div class="text-right" style="text-align:right;margin:20px;">-->
                        <div class="offset-md-4 col-md-5 text-right">
                            <small class="text-muted">{{roviz.countCurrentPlot()}} results selected &nbsp;</small>
                            <button class="btn btn-success" ng-click="roviz.addPlot()">
                                <i class="fe fe-trending-up"></i>
                                Add Plot
                            </button> 
                            <button class="btn btn-light" data-toggle="modal" data-target="#analysisModal">
                                <i class="fa fa-magic"></i>
                                Add Analysis
                            </button> 
                        </div>
                        </div>
                    </div>

                    <div style="display:block; height:100vh;" class="col-md-12 card">
                        <div ag-grid="gridOptions" class="ag-theme-material" style="height:100%;"></div>
                    </div>

                </div>

                <!-- Analysis Plot Modal -->
                <div class="modal fade bd-example-modal-lg" id="analysisModal">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">

                            <!-- Modal Header -->
                            <div class="modal-header">
                                <h4 class="modal-title">Automatic Analysis</h4>
                                <button type="button" class="close" data-dismiss="modal"></button>
                            </div>
                            <!-- Modal body -->
                            <div class="modal-body">
                                <p>
                                Unfortunately, this functionality is not available yet.
                                When it will be, it will allow users to automagically create common predefined --- and in the future custom --- analysis from their data.
                                </p>
                                <p>If interested, feel free to <a href="https://github.com/seba-1511/randopt" target="_blank">get in touch</a> !</p>
                            </div>

                            <!-- Modal footer -->
                            <div class="modal-footer">
                                <button type="button" class="btn btn-error" data-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-success" data-dismiss="modal">Create</button>
                            </div>

                        </div>
                    </div>
                </div>


                <!-- Edit Plot Modal -->
                <div class="modal fade bd-example-modal-lg" id="editModal">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">

                            <!-- Modal Header -->
                            <div class="modal-header">
                                <h4 class="modal-title">Edit Plot</h4>
                                <button type="button" class="close" data-dismiss="modal"></button>
                            </div>
                            <div class="selectgroup">
                                <label class="selectgroup-item">
                                    <input name="editView" value="1" class="selectgroup-input" checked="" type="radio">
                                    <span class="selectgroup-button selectgroup-button-icon"><i class="fe fe-edit"></i></span>
                                </label>
                                <label class="selectgroup-item">
                                    <input name="editView" value="6" class="selectgroup-input" type="radio">
                                    <span class="selectgroup-button selectgroup-button-icon"><i class="fe fe-eye"></i></span>
                                </label>
                            </div>
                            <!-- Modal body -->
                            <div class="modal-body">
                                <p>
                                Here, you can modify the data and layout that we'll use to generate the Plotly plot.
                                </p>
                                <p>
                                For more information, please refer to the <a href="https://plot.ly/javascript/">plotly.js Documentation</a>.
                                </p>

                                <h4>Plot Data</h4>
                                <center>
                                    <textarea rows="10" cols="70" class="code" ng-model="plotToEdit.data"></textarea>
                                </center>

                                <h4>Plot Layout</h4>
                                <center>
                                    <textarea rows="10" cols="70" class="code" ng-model="plotToEdit.layout"></textarea>
                                </center>

                            </div>

                            <!-- Modal footer -->
                            <div class="modal-footer">
                                <button type="button" class="btn btn-error" data-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-success" data-dismiss="modal" ng-click="roviz.savePlot();">Save</button>
                            </div>

                        </div>
                    </div>
                </div>



                <!-- Plots Page -->
                <!--<div ng-show="page == 'plots'" class="container"> -->
                <div ng-class="{'away': page != 'plots'}" class="container">

                    <br />
                    <div id="plot-container" class="text-left col-md-12">
                        <h3 class="noprint">Plots <small>{{roviz.plots.length}}</small></h3>


                        <div class="row">
                            <div class="col-md-10">
                                <div ng-repeat="plot in roviz.plots" class="card print-plot-width col-md-12" ng-class="{'plot-selected': plot.selected};">
                                    <div class="row">
                                        &nbsp;
                                        &nbsp;
                                        <button class="btn btn-sm btn-warning" style="padding:0px;margin-top:5px;margin-bottom:5px;" data-toggle="modal" data-target="#editModal" ng-click="roviz.editPlot(plot.id);">
                                            <i class="fe fe-code"></i>
                                        </button>
                                        <input ng-model="plot.name" class="print-plot-width col-md-11" style="text-align:center;background-color:white;border:none;font-size:20px;" />
                                        <!--<a href="#" class="col-md-1 btn btn-danger" ng-click="roviz.removePlot(plot.id)">Remove</a> -->
                                        <button type="button" class="btn btn-sm btn-danger" style="padding:1px;margin-top:5px;margin-bottom:5px;" ng-click="roviz.removePlot(plot.id)">
                                            <i class="fe fe-x"></i>
                                        </button>
                                        &nbsp;
                                        &nbsp;
                                    </div>
                                    <div class="print-plot-frame print-plot-width" style="height:450px;border:solid black 2px;">
                                        <plotly-plot plot="plot" page="page" roviz="roviz"></plotly-plot>
                                    </div>
                                    <div class="row noprint">
                                        <div class="offset-md-2 col-sm-4 text-center">
                                            X-axis: 
                                            <select class="form-control" style="display:inline;width:100px;height:30px;padding:0px;background-color:white;background:none;border:solid black 0px;overflow:hidden;" ng-model="plot.xtitle">
                                                <option value="None">List Indices</option>
                                                <option ng-repeat="head in roviz.headers">{{head}}</option>
                                            </select>
                                        </div>
                                        <div class="col-sm-4 text-center">
                                            Y-axis: 
                                            <select class="form-control" style="display:inline;width:100px;height:30px;padding:0px;background-color:white;background:none;border:solid black 0px;overflow:hidden;" ng-model="plot.ytitle">
                                                <option value="None">List Indices</option>
                                                <option ng-repeat="head in roviz.headers">{{head}}</option>
                                            </select>
                                        </div>
                                        <div class="col-sm-2 text-right" style="padding-top:0px;">
                                            <input type="checkbox" ng-model="plot.selected"  />
                                            <a ng-click="plot.selected = !plot.selected" style="text-decoration:none;" class="btn btn-sm btn-default" >Select</a>
                                        </div>
                                    </div>
                                    <div class="print-page-break"></div>
                                </div>
                            </div>

                            <div class="col-md-2 noprint">
                                <div class="cold-md-12 card" style="position:sticky;top:8rem;">
                                    <center>
                                        <small class="text-muted">{{roviz.countSelectedPlots()}} plots selected &nbsp;</small>
                                    </center>
                                    <button style="margin:10px;" class="btn btn-success" ng-click="roviz.averagePlots();">Plot Averages</button> 
                                    <button style="margin:10px;" class="btn btn-success" ng-click="roviz.mergePlots();">Merge Plots</button> 
                                </div>
                            </div>

                        </div>
                    </div>

                </div>

                </div>

                <script type="text/javascript">
                    // Copy up to this line in header.html
var DATA = [{"result": -224.23408123198809, "algo": "DDPG", "env_name": "HalfCheetah-v2", "gamma": 0.99, "tau": 0.001, "ou_noise": true, "param_noise": false, "noise_scale": 0.3, "final_noise_scale": 0.3, "exploration_end": 1, "seed": 4, "batch_size": 128, "num_steps": 1000, "num_episodes": 1, "hidden_size": 128, "updates_per_step": 5, "replay_size": 1000000, "train_rewards": [-165.21341246357554], "test_rewards": [-224.23408123198809]}, {"result": 85.89306143039524, "algo": "DDPG", "env_name": "HalfCheetah-v2", "gamma": 0.99, "tau": 0.001, "ou_noise": true, "param_noise": false, "noise_scale": 0.3, "final_noise_scale": 0.3, "exploration_end": 1, "seed": 4, "batch_size": 128, "num_steps": 1000, "num_episodes": 10, "hidden_size": 128, "updates_per_step": 5, "replay_size": 1000000, "train_rewards": [-243.77060616766536, -8.971473038920239, 1.5326356011810471, 19.88857309137543, -65.52113971467543, 1.362430455271151, 95.21106681102519, -68.34418251415269, 54.98983235034639, 118.93477109831427], "test_rewards": [85.89306143039524]}];// Copy from this line to end in footer.html
                </script>
                <script type="text/javascript">

                    agGrid.initialiseAgGridWithAngular1(angular);

var rovizApp = angular.module('rovizApp', ['ngRoute', 'agGrid'])
    .controller('RovizController', function($scope) {

        $scope.page = 'data'
        this.plotsCreated = 0;

        // Table Control
        this.data = DATA;
        this.headers = ['result'];
        for (var key in this.data[0]) {
            if (key !== 'result') {
                this.headers.push(key);
            }
        }
        for (var i=0; i < this.data.length; i++) {
            this.data[i].__idx = i;
            this.data[i].__name = 'Result ' + i;
        }

        var columnDefs = [
            {headerCheckboxSelection: true, checkboxSelection: true},
            {headerName: 'id', field: '__idx'},
            {headerName: 'result', field: 'result'},
        ];

        for (var key in this.data[0]) {
            if (key !== 'result' && !key.startsWith('__')) {
                columnDefs.push({headerName: key, field: key})
            }
        }

        $scope.gridOptions = {
            enableFilter: true,
            enableSorting: true,
            columnDefs: columnDefs,
            rowData: this.data,
            enableColResize: true,
            rowMultiSelectWithClick: true,
            rowDeselection: true,
            suppressRowClickSelection: false,
            rowSelection: 'multiple',
            onGridReady: function(params) {
                params.api.sizeColumnsToFit();
            },
        };

        this.updateQuickFilter = function() {
            var value = document.getElementById('dataFilter').value;
            $scope.gridOptions.api.setQuickFilter(value);
        };

        this.addPlot = function() {
            $scope.page = 'plots';
            var currentPlot = {
                summaries: $scope.gridOptions.api.getSelectedRows(),
                id: this.plotsCreated,
                xtitle: 'None',
                ytitle: 'result',
                name: 'Plot ' + this.plotsCreated,
                selected: false,
                layout: {},
                data: {},
                custom: false,
                num_updates: 0,
            };
            this.plots.push(currentPlot);
            this.plotsCreated++;
            $scope.plotToEdit = {
                data: {},
                layout: {},
                plot: currentPlot,
                showPrev: false,

            };
            this.saveState();
        };

        this.countCurrentPlot = function() {
            return $scope.gridOptions.api.getSelectedRows().length;
        };

        // Keyboard Shortcuts

        var shiftDown = false;
        angular.element(document).bind('keydown', function(event) {
            if (event.which == 16) { // 16 == Shift
                shiftDown = true;
            } 
            if (shiftDown && event.which == 222) { // 222 == ?
                $scope.page = 'home';
                $scope.$apply();
            }
            if (shiftDown && event.which == 68) { // 68 == d
                $scope.page = 'data';
                $scope.$apply();
            }
            if (shiftDown && event.which == 80) { // 80 == p
                $scope.page = 'plots';
                $scope.$apply();
            }
            if (shiftDown && event.which == 72) { // 72 == h
                switch($scope.page) {
                    case 'home':
                        $scope.page = 'plots';
                        break;
                    case 'data':
                        $scope.page = 'home';
                        break;
                    case 'plots':
                        $scope.page = 'data';
                        break;
                }
                $scope.$apply();
            }
            if (shiftDown && event.which == 76) { // 76 == l
                switch($scope.page) {
                    case 'home':
                        $scope.page = 'data';
                        break;
                    case 'data':
                        $scope.page = 'plots';
                        break;
                    case 'plots':
                        $scope.page = 'home';
                        break;
                }
                $scope.$apply();
            }
            if (event.which == 74) { // 74 == j
                window.scrollBy(0, 500);
            }
            if (event.which == 75) { // 75 == k
                window.scrollBy(0, -500);
            }
            if (event.which == 70) { // 70 == f
                var elem = document.documentElement;

                if (document.fullscreenElement) {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.mozCancelFullScreen) { /* Firefox */
                        document.mozCancelFullScreen();
                    } else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
                        document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) { /* IE/Edge */
                        document.msExitFullscreen();
                    }
                }
                else {
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen();
                    }
                    else if (elem.mozRequestFullScreen) { /* Firefox */
                        elem.mozRequestFullScreen();
                    } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
                        elem.webkitRequestFullscreen();
                    } else if (elem.msRequestFullscreen) { /* IE/Edge */
                        elem.msRequestFullscreen();
                    }
                }

            }
        });
        angular.element(document).bind('keyup', function(event) {
            if (event.which == 16) { // 16 == Shift
                shiftDown = false;
            } 
        });

        // Plot Control
        this.plots = [];
        $scope.plotToEdit = {};

        if (window.localStorage[window.location.href] !== null && typeof(window.localStorage[window.location.href]) !== 'undefined') {
            this.plots = JSON.parse(window.localStorage.getItem(window.location.href));
        }


        this.editPlot = function(id) {
            var i, plotToEdit, dataContent, layoutContent;
            for (i=0; i < this.plots.length; i++) {
                if (this.plots[i].id == id) {
                    plotToEdit = this.plots[i];
                    break;
                }
            }
            $scope.plotToEdit.plot = plotToEdit;
            $scope.plotToEdit.layout = JSON.stringify(plotToEdit.layout, null, 4);
            $scope.plotToEdit.data = JSON.stringify(plotToEdit.data, null, 4);
        };

        this.savePlot = function(id) {
            var data, layout;
            data = $scope.plotToEdit.data.replace(/'/g, '"');
            layout = $scope.plotToEdit.layout.replace(/'/g, '"');
            try {
                data = JSON.parse($scope.plotToEdit.data);
            }
            catch (err) {
                data = eval($scope.plotToEdit.data);        
            }
            try {
                layout = JSON.parse($scope.plotToEdit.layout);
            }
            catch (err) {
                layout = eval($scope.plotToEdit.layout);        
            }
            $scope.plotToEdit.plot.data = data;
            $scope.plotToEdit.plot.layout = layout;
            $scope.plotToEdit.plot.custom = true;
            $scope.plotToEdit.plot.num_updates++;
            this.saveState();
        };

        this.removePlot = function(id) {
            var i;
            for (i=0; i < this.plots.length; i++) {
                if (this.plots[i].id == id) {
                    this.plots.splice(i, 1);
                }
            }
            this.saveState();
        };

        this.countSelectedPlots = function() {
            var i, count = 0;
            for (i=0; i < this.plots.length; i++) {
                if (this.plots[i].selected == 1) {
                    count++;
                }
            }
            return count;
        };

        this.mergePlots = function() {
            var i, j, plots = [];
            var currentPlot;
            currentPlot = {
                summaries: [],
                id: this.plotsCreated,
                xtitle: 'None',
                ytitle: 'result',
                name: 'Merge ' + this.plotsCreated,
                selected: false,
                data: {},
                layout: {},
            };
            for (i=0; i < this.plots.length; i++) {
                if (this.plots[i].selected) {
                    for (j=0; j < this.plots[i].data.length; j++) {
                        currentPlot.summaries.push(this.plots[i].data[j]);
                    }
                    this.plots[i].selected = false;
                }
            }
            this.plots.push(currentPlot);
            this.plotsCreated++;
            this.saveState();
        };

        this.averagePlots = function() {
            var i, j, h, plots = [];
            var currentPlot, header, new_data, header_avg, header_data;
            currentPlot = {
                summaries: [],
                id: this.plotsCreated,
                xtitle: 'None',
                ytitle: 'result',
                name: 'Average ' + this.plotsCreated,
                selected: false,
                data: {},
                layout: {},
            };
            for (i=0; i < this.plots.length; i++) {
                if (this.plots[i].selected) {
                    new_data = {};

                    for (h=0; h < this.headers.length; h++) {
                        header = this.headers[h];
                        header_avg = this.plots[i].summaries[0][header];

                        for (j=1; j < this.plots[i].summaries.length; j++) {
                            // For each data (curve), you need to compute the average
                            header_data = this.plots[i].summaries[j][header];
                            if (typeof header_data.map === 'function') {
                                header_avg = header_avg.map(function(num, idx) {
                                    return num + header_data[idx];
                                });
                            }
                            else {
                                header_avg = header_avg + header_data;
                            }
                        }
                        if (typeof header_avg.map === 'function') {
                            thisplots = this.plots;
                            header_avg = header_avg.map(function(num, idx) {
                                return num / thisplots[i].summaries.length;
                            });
                        }
                        else {
                            header_avg = header_avg / this.plots[i].summaries.length;
                        }

                        new_data[header] = header_avg;
                    }

                    new_data.__name = this.plots[i].name;
                    currentPlot.summaries.push(new_data);
                    this.plots[i].selected = false;
                }
            }
            this.plots.push(currentPlot);
            this.plotsCreated++;
            this.saveState();
        };


        this.export = function() {
            var copy, file, html;
            copy = (' ' + CODE).slice(1); // Makes a deep copy
            plots = [];
            for (i=0; i < this.plots.length; i++) { 
                p = Object.assign({}, this.plots[i]); // Deep copy
                delete p['$$hashKey']; // Remove angular annotations
                plots.push(p);
            }
            plot_content = JSON.stringify(plots);
            search = 'this.plots = ';
            start_idx = copy.indexOf(search);
            start = copy.substr(0, start_idx + search.length);
            end = copy.substr(start_idx + search.length + 2);
            content = start + plot_content + end;
            file = "data:text/plain;charset=utf-8," + encodeURIComponent(content);
            window.open(file, 'export');
        };

        this.saveState = function() {
            var copy, file, html;
            copy = (' ' + CODE).slice(1); // Makes a deep copy
            plots = [];
            for (i=0; i < this.plots.length; i++) { 
                p = Object.assign({}, this.plots[i]); // Deep copy
                delete p['$$hashKey']; // Remove angular annotations
                plots.push(p);
            }
            plot_content = JSON.stringify(plots);
            window.localStorage.setItem(window.location.href, plot_content);
        };


        // Enable plugins
    }).directive('plotlyPlot', [function() {

        var xrange = function(N) {
            var i, a = [];
            for (i=0; i < N; i++) {
                a.push(i);
            }
            return a;
        };

        var renderPlot = function(scope, element, attrs) {
            var traces = [];
            var i, data, trace, xdata, ydata;
            if (!scope.plot.custom) {
                for (i=0; i < scope.plot.summaries.length; i++) {
                    data = scope.plot.summaries[i];
                    if (scope.plot.xtitle === 'None') {
                        xdata = xrange(data[scope.plot.ytitle].length);
                    } else {
                        xdata = data[scope.plot.xtitle];
                    }
                    if (scope.plot.ytitle === 'None') {
                        ydata = xrange(data[scope.plot.xtitle].length);
                    } else {
                        ydata = data[scope.plot.ytitle];
                    }
                    if (!Array.isArray(xdata)) {
                        xdata = [xdata, ];
                    }
                    if (!Array.isArray(ydata)) {
                        ydata = [ydata, ];
                    }
                    trace = {
                        x: xdata,
                        y: ydata,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: data.__name,

                    };
                    traces.push(trace);
                }
                var layout = {
                    xaxis: {title: scope.plot.xtitle, showticklabels: true},
                    yaxis: {title: scope.plot.ytitle, showticklabels: true},
                    width: element[0].parentElement.clientWidth -10,
                    height: element[0].parentElement.clientHeight -10,
                    margin: {l:30, t:0, r:0, b:30},
                    showlegend: true,
                    legend: {x: 0.85, y: 0.95, traceorder: 'normal'}
                };
                scope.plot.layout = layout;
                scope.plot.data = traces;
            }
            scope.roviz.saveState();
            Plotly.newPlot(element[0], scope.plot.data, scope.plot.layout);

        };

        return {
            restrict: 'EACM',
            template: '<div></div>',
            link: function(scope, element, attrs) {
                scope.$watch('plot.xtitle', function(oldVal, newVal) {
                    setTimeout(function(){renderPlot(scope, element, attrs);}, 100)
                });
                scope.$watch('plot.ytitle', function(oldVal, newVal) {
                    setTimeout(function(){renderPlot(scope, element, attrs);}, 100)
                });
                scope.$watch('plot.num_updates', function(oldVal, newVal) {
                    setTimeout(function(){renderPlot(scope, element, attrs);}, 100)
                });
                angular.element(element[0]).bind('resize', function() {
                    setTimeout(function(){renderPlot(scope, element, attrs);}, 100)
                });
            },
        };
    }]);

                </script>
                <script type="text/javascript">
                    var CODE;
                    document.addEventListener("DOMContentLoaded", function(event) {
                        CODE = document.documentElement.outerHTML;
                    });
                </script>
    </body>
</html>
